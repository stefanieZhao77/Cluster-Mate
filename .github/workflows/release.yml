name: Create Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  discussions: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Set fixed version
      run: |
        echo "NEW_VERSION=v0.0.1" >> $env:GITHUB_ENV
      shell: pwsh
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Create Version File
      run: |
        $version_info = @"
        VSVersionInfo(
          ffi=FixedFileInfo(
            filevers=(0,0,1,0),
            prodvers=(0,0,1,0),
            mask=0x3f,
            flags=0x0,
            OS=0x40004,
            fileType=0x1,
            subtype=0x0,
            date=(0, 0)
          ),
          kids=[
            StringFileInfo([
              StringTable(
                u'040904B0',
                [StringStruct(u'CompanyName', u'Cluster-Mate'),
                StringStruct(u'FileDescription', u'Clustering Analysis Tool'),
                StringStruct(u'FileVersion', u'0.0.1'),
                StringStruct(u'InternalName', u'clustering_gui'),
                StringStruct(u'LegalCopyright', u'Copyright (c) 2024'),
                StringStruct(u'OriginalFilename', u'clustering_gui.exe'),
                StringStruct(u'ProductName', u'Cluster-Mate'),
                StringStruct(u'ProductVersion', u'0.0.1')])
            ]),
            VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
          ]
        )
        "@ | Out-File -Encoding utf8 version_info.txt
      shell: pwsh
        
    - name: Build with PyInstaller
      run: |
        pyinstaller --clean ^
          --name clustering_gui ^
          --windowed ^
          --onefile ^
          --icon=GUI/assets/icon.ico ^
          --version-file=version_info.txt ^
          --add-data "GUI;GUI" ^
          --collect-all customtkinter ^
          --collect-all PIL ^
          --collect-all pandas ^
          --collect-all numpy ^
          --collect-all sklearn ^
          GUI/main.py
        
    - name: Delete old release
      run: |
        gh release delete v0.0.1 --yes
      continue-on-error: true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v0.0.1
        name: Debug Build
        files: |
          dist/clustering_gui.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 